<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>MySQL 調優 | Charset &amp; Collation 不一致導致的 JOIN 索引失效 - William Right&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="William Right&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="William Right&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="年前接獲了一個需求, 協助海外團隊組合一些舊系統的交易資料, 結果意外的發現了一些 SQL 上的效能議題, 就順便做了個 Demo 測試一下..."><meta property="og:type" content="blog"><meta property="og:title" content="MySQL 調優 | Charset &amp; Collation 不一致導致的 JOIN 索引失效"><meta property="og:url" content="https://williamrightone.github.io/2026/02/14/table-collation-issue/"><meta property="og:site_name" content="William Right&#039;s Blog"><meta property="og:description" content="年前接獲了一個需求, 協助海外團隊組合一些舊系統的交易資料, 結果意外的發現了一些 SQL 上的效能議題, 就順便做了個 Demo 測試一下..."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://williamrightone.github.io/img/og_image.png"><meta property="article:published_time" content="2026-02-14T07:38:40.000Z"><meta property="article:modified_time" content="2026-02-14T07:39:48.344Z"><meta property="article:author" content="William Wu"><meta property="article:tag" content="develop"><meta property="article:tag" content="DB"><meta property="article:tag" content="troll"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://williamrightone.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://williamrightone.github.io/2026/02/14/table-collation-issue/"},"headline":"MySQL 調優 | Charset & Collation 不一致導致的 JOIN 索引失效","image":["https://williamrightone.github.io/img/og_image.png"],"datePublished":"2026-02-14T07:38:40.000Z","dateModified":"2026-02-14T07:39:48.344Z","author":{"@type":"Person","name":"William Wu"},"publisher":{"@type":"Organization","name":"William Right's Blog","logo":{"@type":"ImageObject","url":"https://williamrightone.github.io/img/PIX.png"}},"description":"年前接獲了一個需求, 協助海外團隊組合一些舊系統的交易資料, 結果意外的發現了一些 SQL 上的效能議題, 就順便做了個 Demo 測試一下..."}</script><link rel="canonical" href="https://williamrightone.github.io/2026/02/14/table-collation-issue/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-S29D3Z45V4" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-S29D3Z45V4');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/PIX.png" alt="William Right&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2026-02-14T07:38:40.000Z" title="2026/2/14 下午3:38:40">2026-02-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2026-02-14T07:39:48.344Z" title="2026/2/14 下午3:39:48">2026-02-14</time></span><span class="level-item"><a class="link-muted" href="/categories/develop/">develop</a></span><span class="level-item">23 minutes read (About 3510 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">MySQL 調優 | Charset &amp; Collation 不一致導致的 JOIN 索引失效</h1><div class="content"><p>放假前夕, 海外團隊請我們協助查詢出一些舊系統相關的交易資料, 資料也算平易近人, 在簡短討論 15 分鐘後就下線去組 SQL 了, 結果當我 JOIN 到指定 table 的時後, 發現查詢速度竟然顯著的下降, 到我完全不能接受的程度.</p>
<p>當年唸書時學長有交代一系列的 SQL 調優流程, <del>在多年的 CRUD 的荼毒下</del> 在年假氣氛的渲染下我只記得先下個 <code>EXPLAIN</code> 看看.</p>
<table>
<thead>
<tr>
<th>type</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>Using where; Using join buffer (Block Nested Loop)</td>
</tr>
</tbody></table>
<blockquote>
<p>Using where; Using join buffer (Block Nested Loop) ?!</p>
</blockquote>
<p>恩… 這問題大了, type 都 <code>ALL</code> 了, 我印象中 <code>Using join buffer (Block Nested Loop)</code> 代表 JOIN 的時候沒有有效地使用 INDEX, SQL 是直接暴力在比對資料, 而且這個系統用的應該是 MySQL 6 以前的版本.</p>
<p>這個問題的原由一般常見的是 JOIN 欄位沒有設 index, 但是這次的欄位都是用 order_id 這種一看就該下索引的欄位, 且這個 id 是字母 + 數字的形式, 基本上也可以排除兩個表的 id JOIN 型別不同的問題 (例如一張表用 int 一張表用 varchar, 這樣 MySQL 就需要 <code>CAST(o.id AS char)</code>), 同時 JOIN 條件也沒有函式讓索引失效(如 <code>JOIN xxx ON LOWER(xxx.email) = LOWER(ooo.email)</code>).</p>
<p>在 <code>SHOW INDEX</code> 無果後就針對這兩張表的 id 去查 <code>SHOW FULL COLUMNS</code>, 果然看出了一些端倪:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Collation</th>
</tr>
</thead>
<tbody><tr>
<td>order_id</td>
<td>varchar(32)</td>
<td>utf8_general_ci</td>
</tr>
</tbody></table>
<p>和</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Collation</th>
</tr>
</thead>
<tbody><tr>
<td>order_id</td>
<td>varchar(32)</td>
<td>utf8mb4_bin</td>
</tr>
</tbody></table>
<blockquote>
<p>啊你們的 charset 和 Collation 怎麼都不一樣…</p>
</blockquote>
<p>稍微查證了一下, 原來兩個表是由不同團隊開發和維護，一個使用 <code>utf8</code>；後來新建的使用 <code>utf8mb4</code>。兩邊的 <strong>charset 與 collation 不一致</strong>，導致 MySQL 在 JOIN 時必須做隱式轉換(Implicit conversion)，索引因此失效。</p>
<p>再查證一遍 MySQL EXPLAIN 的 Output, 果然看到了 <code>convert(xxx.order_id using utf8mb4)...</code>, 就是 charset &amp; collation mismatch 導致 Index 全部失效了.</p>
<p>utf8 我記得是 3-byte UTF-8(現在應該會叫 utf8mb3), utf8mb4 才是完整 4-byte UTF-8, 接著順便上網看了一下細節, utf8mb4_general_ci 和 utf8mb4_bin 的差異:</p>
<table>
<thead>
<tr>
<th>collation</th>
<th>說明</th>
</tr>
</thead>
<tbody><tr>
<td>utf8mb4_general_ci</td>
<td>不區分大小寫</td>
</tr>
<tr>
<td>utf8mb4_bin</td>
<td>binary 精準比較</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>比較</th>
<th>general_ci</th>
<th>bin</th>
</tr>
</thead>
<tbody><tr>
<td>A &#x3D; a</td>
<td>true</td>
<td>false</td>
</tr>
<tr>
<td>銀行 &#x3D; 银行</td>
<td>可能 true</td>
<td>false</td>
</tr>
</tbody></table>
<p>找到原因修正起來也很簡單, 和主管簡單回報了這件事情後, 我回家也讓 Claude 幫我生成了兩組資料做測試, 重新模擬一次這個問題.</p>
<p>不過是說 production 都沒有相關的效能問題嗎？還是只有 sit&#x2F;uat 沒同步, 我也無從得知.</p>
<hr>
<h2 id="實驗-A：Charset-Mismatch（utf8-vs-utf8mb4）"><a href="#實驗-A：Charset-Mismatch（utf8-vs-utf8mb4）" class="headerlink" title="實驗 A：Charset Mismatch（utf8 vs utf8mb4）"></a>實驗 A：Charset Mismatch（utf8 vs utf8mb4）</h2><blockquote>
<p>模擬我在工作中遇到的情況, 舊系統 charset 用 <code>utf8</code>, 新服務用 <code>utf8mb4</code>, 跨庫 or 新舊表 JOIN 時產生效能問題.</p>
</blockquote>
<h3 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h3><ol>
<li>docker-compose 啟動一個 Mysql</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:<span class="number">8</span></span><br><span class="line">    container_name: <span class="keyword">all</span><span class="operator">-</span>you<span class="operator">-</span>can<span class="operator">-</span>test<span class="operator">-</span>mysql</span><br><span class="line">    restart: unless<span class="operator">-</span>stopped</span><br><span class="line">    ports:</span><br><span class="line">      <span class="operator">-</span> &quot;3306:3306&quot;</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: imroot1234</span><br><span class="line">      MYSQL_DATABASE: <span class="keyword">all</span><span class="operator">-</span>tests</span><br><span class="line">    volumes:</span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>mysql_data:<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>建立 DATABASE (utf8mb4)</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> charset_demo <span class="keyword">DEFAULT</span> CHARSET utf8mb4;</span><br><span class="line">USE charset_demo;</span><br></pre></td></tr></table></figure>

<h3 id="場景說明"><a href="#場景說明" class="headerlink" title="場景說明"></a>場景說明</h3><ul>
<li><strong>商品表 <code>product</code></strong>：模擬舊系統，建表時用 <code>utf8</code>（歷史遺留）</li>
<li><strong>訂單明細表 <code>order_item</code></strong>：模擬新系統，建表時用 <code>utf8mb4</code></li>
<li><strong>JOIN 欄位</strong>：<code>product_code</code>（商品編碼）</li>
</ul>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 商品表（舊系統 —— utf8 + utf8_general_ci）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> product;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> product (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    product_code <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    category <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    INDEX idx_product_code (product_code)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 訂單明細表（新系統 —— utf8mb4 + utf8mb4_bin）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> order_item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_item (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">48</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_code <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    unit_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at DATETIME <span class="keyword">NOT NULL</span>,</span><br><span class="line">    INDEX idx_product_code (product_code)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin;</span><br></pre></td></tr></table></figure>

<p>這裡備註一下, 你可能會看到:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 這個是回傳 warning, 可以無視</span><br><span class="line">Unknown table &#x27;charset_demo.product&#x27;</span><br><span class="line"></span><br><span class="line"># 重點是這個</span><br><span class="line">&#x27;utf8&#x27; is currently an alias <span class="keyword">for</span> the character <span class="built_in">set</span> UTF8MB3, but will be an alias <span class="keyword">for</span> UTF8MB4 <span class="keyword">in</span> a future release. Please consider using UTF8MB4 <span class="keyword">in</span> order to be unambiguous.</span><br><span class="line">&#x27;utf8mb3_general_ci&#x27; is a collation of the deprecated character <span class="built_in">set</span> UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</span><br><span class="line">&#x27;utf8&#x27; is currently an alias <span class="keyword">for</span> the character <span class="built_in">set</span> UTF8MB3, but will be an alias <span class="keyword">for</span> UTF8MB4 <span class="keyword">in</span> a future release. Please consider using UTF8MB4 <span class="keyword">in</span> order to be unambiguous.</span><br><span class="line">&#x27;utf8mb3_general_ci&#x27; is a collation of the deprecated character <span class="built_in">set</span> UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</span><br></pre></td></tr></table></figure>

<p>MySQL 官方已宣告 <code>utf8mb3</code> 將被移除, 所以其實在 MySQL 8 的環境下跑, 自然就會收到警示訊息, 不過我們現在是模擬新舊系統, 所以理解後忽略即可.</p>
<p>執行完後可以在 ide 內看到字元集 product 是 <code>utf8mb3</code>, order_item 是 <code>utf8mb4</code>.</p>
<h3 id="灌入測試資料"><a href="#灌入測試資料" class="headerlink" title="灌入測試資料"></a>灌入測試資料</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 商品表：50,000 筆</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> product (product_code, product_name, category, price)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    CONCAT(<span class="string">&#x27;SKU&#x27;</span>, LPAD(n, <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)),</span><br><span class="line">    CONCAT(<span class="string">&#x27;Product-&#x27;</span>, n),</span><br><span class="line">    ELT(<span class="number">1</span> <span class="operator">+</span> <span class="built_in">FLOOR</span>(RAND()<span class="operator">*</span><span class="number">10</span>),</span><br><span class="line">        <span class="string">&#x27;Electronics&#x27;</span>,<span class="string">&#x27;Clothing&#x27;</span>,<span class="string">&#x27;Food&#x27;</span>,<span class="string">&#x27;Furniture&#x27;</span>,<span class="string">&#x27;Sports&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Books&#x27;</span>,<span class="string">&#x27;Toys&#x27;</span>,<span class="string">&#x27;Beauty&#x27;</span>,<span class="string">&#x27;Health&#x27;</span>,<span class="string">&#x27;Garden&#x27;</span>),</span><br><span class="line">    ROUND(<span class="number">10</span> <span class="operator">+</span> RAND()<span class="operator">*</span><span class="number">9990</span>,<span class="number">2</span>)</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="variable">@row</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> n</span><br><span class="line">    <span class="keyword">FROM</span> information_schema.columns,</span><br><span class="line">         (<span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="number">0</span>) t</span><br><span class="line">    LIMIT <span class="number">50000</span></span><br><span class="line">) x;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 訂單明細表：200,000 筆</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> order_item (order_no, product_code, quantity, unit_price, created_at)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    CONCAT(<span class="string">&#x27;ORD&#x27;</span>, LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND() <span class="operator">*</span> <span class="number">80000</span>), <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)),</span><br><span class="line">    CONCAT(<span class="string">&#x27;SKU&#x27;</span>, LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND() <span class="operator">*</span> <span class="number">50000</span>), <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)),</span><br><span class="line">    <span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND() <span class="operator">*</span> <span class="number">10</span>),</span><br><span class="line">    ROUND(<span class="number">10</span> <span class="operator">+</span> RAND() <span class="operator">*</span> <span class="number">9990</span>, <span class="number">2</span>),</span><br><span class="line">    DATE_ADD(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="type">INTERVAL</span> <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">365</span>) <span class="keyword">DAY</span>)</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="variable">@row</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> n</span><br><span class="line">    <span class="keyword">FROM</span> information_schema.columns c1,</span><br><span class="line">         information_schema.columns c2,</span><br><span class="line">         (<span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="number">0</span>) t</span><br><span class="line">    LIMIT <span class="number">200000</span></span><br><span class="line">) x;</span><br></pre></td></tr></table></figure>

<h3 id="Step-1：確認-Charset-Collation-不一致"><a href="#Step-1：確認-Charset-Collation-不一致" class="headerlink" title="Step 1：確認 Charset &#x2F; Collation 不一致"></a>Step 1：確認 Charset &#x2F; Collation 不一致</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> product <span class="keyword">LIKE</span> <span class="string">&#x27;product_code&#x27;</span>;</span><br><span class="line"><span class="comment">-- utf8mb3_general_ci</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> order_item <span class="keyword">LIKE</span> <span class="string">&#x27;product_code&#x27;</span>;</span><br><span class="line"><span class="comment">-- utf8mb4_bin</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-2：EXPLAIN-觀察問題"><a href="#Step-2：EXPLAIN-觀察問題" class="headerlink" title="Step 2：EXPLAIN 觀察問題"></a>Step 2：EXPLAIN 觀察問題</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    p.product_code,</span><br><span class="line">    p.product_name,</span><br><span class="line">    p.category,</span><br><span class="line">    <span class="built_in">SUM</span>(oi.quantity) <span class="keyword">AS</span> total_qty,</span><br><span class="line">    <span class="built_in">SUM</span>(oi.quantity <span class="operator">*</span> oi.unit_price) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">FROM</span> order_item oi</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> product p <span class="keyword">ON</span> oi.product_code <span class="operator">=</span> p.product_code</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> p.product_code, p.product_name, p.category</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_sales <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h4 id="結果（問題狀態）"><a href="#結果（問題狀態）" class="headerlink" title="結果（問題狀態）"></a>結果（問題狀態）</h4><table>
<thead>
<tr>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>oi</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>199,500</td>
<td>Using temporary; Using filesort</td>
</tr>
<tr>
<td><strong>p</strong></td>
<td><strong>ALL</strong></td>
<td><strong>idx_product_code</strong></td>
<td><strong>NULL</strong></td>
<td><strong>3,690</strong></td>
<td><strong>Range checked for each record (index map: 0x2)</strong></td>
</tr>
</tbody></table>
<p>首先看 <code>p</code> 表的 <code>possible_keys</code> 顯示 <code>idx_product_code</code>, 等於有索引，但 <code>key</code> 是 <code>NULL</code>, 表示<strong>實際沒用到</strong>. 雖然 MySQL 知道有索引可用，但因為 charset&#x2F;collation 不一致，實際上無法有效利用, 最壞情況下的比較量級是 200,000 × 50,000 &#x3D; 100 億次 (至於 rows 數量差異是 MySQL 估算值, 不用太在意).</p>
<p>再來看 Extra 跑出來的內容不再是 <code>Using where; Using join buffer (Block Nested Loop)</code>, 取而代之的是 <code>Range checked for each record (index map: 0x2)</code>.</p>
<p>在 MySQL 5.7 中 Block Nested Loop, 直接放棄索引，把資料塞進 join buffer 暴力比對, 而 MySQL 8.0 Range checked for each record 是對每一筆 order_item 的資料都重新評估一次這筆值用索引划不划算.</p>
<blockquote>
<p>本質上還是因為 collation mismatch 導致無法直接走 B-Tree lookup</p>
</blockquote>
<p>另外看 <code>SHOW WARNINGS</code> 的輸出, 幫大家畫重點:</p>
<blockquote>
<p>Cannot use ref access on index ‘idx_product_code’ due to type or collation conversion on field ‘product_code’</p>
</blockquote>
<p>雖然 8.0 的 rewritten query 中不像 5.7 會顯式出現 <code>convert()</code>，但這句 warning 已經明確說明因為 type 或 collation 的轉換，索引無法使用</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cannot use ref access on index &#x27;idx_product_code&#x27; due to <span class="built_in">type</span> or collation conversion on field &#x27;product_code&#x27;</span><br><span class="line">/* select#<span class="number">1</span> */ select `charset_demo`.`p`.`product_code` AS `product_code`,`charset_demo`.`p`.`product_name` AS `product_name`,`charset_demo`.`p`.`category` AS `category`,sum(`charset_demo`.`oi`.`quantity`) AS `total_qty`,sum((`charset_demo`.`oi`.`quantity` * `charset_demo`.`oi`.`unit_price`)) AS `total_sales` from `charset_demo`.`order_item` `oi` left join `charset_demo`.`product` `p` on((`charset_demo`.`oi`.`product_code` = `charset_demo`.`p`.`product_code`)) where true group by `charset_demo`.`p`.`product_code`,`charset_demo`.`p`.`product_name`,`charset_demo`.`p`.`category` order by `total_sales` desc</span><br></pre></td></tr></table></figure>

<p>綜上所述，MySQL 在比較時需要將 <code>utf8</code> 側的 <code>p.product_code</code> 轉換為 <code>utf8mb4</code>，這個轉換導致 B-Tree 索引無法使用，退化為全表掃描</p>
<h3 id="Step-3：修復"><a href="#Step-3：修復" class="headerlink" title="Step 3：修復"></a>Step 3：修復</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER TABLE</span> product</span><br><span class="line">MODIFY <span class="keyword">COLUMN</span> product_code <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Step-4：修復後-EXPLAIN"><a href="#Step-4：修復後-EXPLAIN" class="headerlink" title="Step 4：修復後 EXPLAIN"></a>Step 4：修復後 EXPLAIN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    p.product_code, p.product_name, p.category,</span><br><span class="line">    <span class="built_in">SUM</span>(oi.quantity) <span class="keyword">AS</span> total_qty,</span><br><span class="line">    <span class="built_in">SUM</span>(oi.quantity <span class="operator">*</span> oi.unit_price) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">FROM</span> order_item oi</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> product p <span class="keyword">ON</span> oi.product_code <span class="operator">=</span> p.product_code</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> p.product_code, p.product_name, p.category</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_sales <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h4 id="修復後結果"><a href="#修復後結果" class="headerlink" title="修復後結果"></a>修復後結果</h4><table>
<thead>
<tr>
<th>table</th>
<th>type</th>
<th>key</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>oi</td>
<td>ALL</td>
<td>NULL</td>
<td>199,500</td>
<td>Using temporary; Using filesort</td>
</tr>
<tr>
<td><strong>p</strong></td>
<td><strong>ref</strong></td>
<td><strong>idx_product_code</strong></td>
<td><strong>1</strong></td>
<td>NULL</td>
</tr>
</tbody></table>
<p><code>p</code> 表從掃描 50,000 行變為每次只查 1 行，Range checked for each record 消失。</p>
<hr>
<h2 id="實驗-B：Collation-Only-Mismatch（同-charset，不同-collation）"><a href="#實驗-B：Collation-Only-Mismatch（同-charset，不同-collation）" class="headerlink" title="實驗 B：Collation-Only Mismatch（同 charset，不同 collation）"></a>實驗 B：Collation-Only Mismatch（同 charset，不同 collation）</h2><p>既然都在測了，順便也驗證一下另一種情況：charset 相同都是 <code>utf8mb4</code>，但 collation 不同。這在實務中也算常見, 不同團隊建表時各自選了不同的 collation 預設值。</p>
<h3 id="場景說明-1"><a href="#場景說明-1" class="headerlink" title="場景說明"></a>場景說明</h3><ul>
<li><strong>商品表 <code>product_b</code></strong>：使用 <code>utf8mb4_general_ci</code>（某些框架的預設值）</li>
<li><strong>訂單明細表 <code>order_item_b</code></strong>：使用 <code>utf8mb4_bin</code>（另一團隊偏好精確比對）</li>
</ul>
<h3 id="建表-1"><a href="#建表-1" class="headerlink" title="建表"></a>建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 商品表（utf8mb4_general_ci）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> product_b;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> product_b (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    product_code <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    category <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    INDEX idx_product_code (product_code)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 訂單明細表（utf8mb4_bin）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> order_item_b;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_item_b (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">48</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_code <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    unit_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at DATETIME <span class="keyword">NOT NULL</span>,</span><br><span class="line">    INDEX idx_product_code (product_code)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h3 id="灌入測試資料-1"><a href="#灌入測試資料-1" class="headerlink" title="灌入測試資料"></a>灌入測試資料</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 商品表 B：50,000 筆</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> product_b (product_code, product_name, category, price)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    CONCAT(<span class="string">&#x27;SKU&#x27;</span>, LPAD(n, <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)),</span><br><span class="line">    CONCAT(<span class="string">&#x27;Product-&#x27;</span>, n),</span><br><span class="line">    ELT(<span class="number">1</span> <span class="operator">+</span> <span class="built_in">FLOOR</span>(RAND()<span class="operator">*</span><span class="number">10</span>),</span><br><span class="line">        <span class="string">&#x27;Electronics&#x27;</span>,<span class="string">&#x27;Clothing&#x27;</span>,<span class="string">&#x27;Food&#x27;</span>,<span class="string">&#x27;Furniture&#x27;</span>,<span class="string">&#x27;Sports&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Books&#x27;</span>,<span class="string">&#x27;Toys&#x27;</span>,<span class="string">&#x27;Beauty&#x27;</span>,<span class="string">&#x27;Health&#x27;</span>,<span class="string">&#x27;Garden&#x27;</span>),</span><br><span class="line">    ROUND(<span class="number">10</span> <span class="operator">+</span> RAND()<span class="operator">*</span><span class="number">9990</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="variable">@row</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> n</span><br><span class="line">    <span class="keyword">FROM</span> information_schema.columns,</span><br><span class="line">         (<span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="number">0</span>) t</span><br><span class="line">    LIMIT <span class="number">50000</span></span><br><span class="line">) x;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 訂單明細表 B：200,000 筆</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> order_item_b (order_no, product_code, quantity, unit_price, created_at)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    CONCAT(<span class="string">&#x27;ORD&#x27;</span>, LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND()<span class="operator">*</span><span class="number">80000</span>), <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)),</span><br><span class="line">    CONCAT(<span class="string">&#x27;SKU&#x27;</span>, LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND()<span class="operator">*</span><span class="number">50000</span>), <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)),</span><br><span class="line">    <span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND()<span class="operator">*</span><span class="number">10</span>),</span><br><span class="line">    ROUND(<span class="number">10</span> <span class="operator">+</span> RAND()<span class="operator">*</span><span class="number">9990</span>, <span class="number">2</span>),</span><br><span class="line">    DATE_ADD(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="type">INTERVAL</span> <span class="built_in">FLOOR</span>(RAND()<span class="operator">*</span><span class="number">365</span>) <span class="keyword">DAY</span>)</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="variable">@row</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> n</span><br><span class="line">    <span class="keyword">FROM</span> information_schema.columns c1,</span><br><span class="line">         information_schema.columns c2,</span><br><span class="line">         (<span class="keyword">SELECT</span> <span class="variable">@row</span> :<span class="operator">=</span> <span class="number">0</span>) t</span><br><span class="line">    LIMIT <span class="number">200000</span></span><br><span class="line">) x;</span><br></pre></td></tr></table></figure>

<h3 id="Step-1：確認-Collation-不一致"><a href="#Step-1：確認-Collation-不一致" class="headerlink" title="Step 1：確認 Collation 不一致"></a>Step 1：確認 Collation 不一致</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> product_b <span class="keyword">LIKE</span> <span class="string">&#x27;product_code&#x27;</span>;</span><br><span class="line"><span class="comment">-- utf8mb4_general_ci</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> order_item_b <span class="keyword">LIKE</span> <span class="string">&#x27;product_code&#x27;</span>;</span><br><span class="line"><span class="comment">-- utf8mb4_bin</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-2：EXPLAIN-觀察"><a href="#Step-2：EXPLAIN-觀察" class="headerlink" title="Step 2：EXPLAIN 觀察"></a>Step 2：EXPLAIN 觀察</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    p.product_code, p.product_name, p.category,</span><br><span class="line">    <span class="built_in">SUM</span>(oi.quantity) <span class="keyword">AS</span> total_qty,</span><br><span class="line">    <span class="built_in">SUM</span>(oi.quantity <span class="operator">*</span> oi.unit_price) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">FROM</span> order_item_b oi</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> product_b p <span class="keyword">ON</span> oi.product_code <span class="operator">=</span> p.product_code</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> p.product_code, p.product_name, p.category</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_sales <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>oi</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>199,500</td>
<td>Using temporary; Using filesort</td>
</tr>
<tr>
<td><strong>p</strong></td>
<td><strong>ALL</strong></td>
<td><strong>idx_product_code</strong></td>
<td><strong>NULL</strong></td>
<td><strong>3,701</strong></td>
<td><strong>Range checked for each record (index map: 0x2)</strong></td>
</tr>
</tbody></table>
<p>可以看到結果一樣是 <code>Range checked for each record (index map: 0x2)</code>.</p>
<h3 id="Step-3：修復-1"><a href="#Step-3：修復-1" class="headerlink" title="Step 3：修復"></a>Step 3：修復</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER TABLE</span> product_b</span><br><span class="line">MODIFY <span class="keyword">COLUMN</span> product_code <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT NULL</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="知識總結"><a href="#知識總結" class="headerlink" title="知識總結"></a>知識總結</h2><h3 id="為什麼-Charset-Mismatch-比-Collation-Mismatch-更致命？"><a href="#為什麼-Charset-Mismatch-比-Collation-Mismatch-更致命？" class="headerlink" title="為什麼 Charset Mismatch 比 Collation Mismatch 更致命？"></a>為什麼 Charset Mismatch 比 Collation Mismatch 更致命？</h3><table>
<thead>
<tr>
<th>比較</th>
<th>Charset Mismatch</th>
<th>Collation-Only Mismatch</th>
</tr>
</thead>
<tbody><tr>
<td>例子</td>
<td><code>utf8</code> vs <code>utf8mb4</code></td>
<td><code>utf8mb4_general_ci</code> vs <code>utf8mb4_bin</code></td>
</tr>
<tr>
<td>是否需要字符集轉換</td>
<td>是，必須 <code>CONVERT()</code></td>
<td>不需要，只需統一排序規則</td>
</tr>
<tr>
<td>索引是否失效</td>
<td><strong>100% 失效</strong></td>
<td>通常失效，但取決於版本和組合</td>
</tr>
<tr>
<td>MySQL 隱式行為</td>
<td>自動將低位元組的一方升級（utf8 -&gt; utf8mb4）</td>
<td>根據 coercibility 規則選一方轉換</td>
</tr>
</tbody></table>
<p><strong>Charset 不同必然導致 collation 不同</strong>（因為 collation 隸屬於 charset），所以 charset mismatch 同時觸發兩層問題。</p>
<h3 id="MySQL-隱式轉換的規則"><a href="#MySQL-隱式轉換的規則" class="headerlink" title="MySQL 隱式轉換的規則"></a>MySQL 隱式轉換的規則</h3><p>MySQL 依照 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/charset-collation-coercibility.html">coercibility</a> 等級決定轉換方向：</p>
<ol>
<li>字面值（coercibility &#x3D; 4）讓步於欄位（coercibility &#x3D; 2）</li>
<li>欄位之間，<code>utf8</code> 會被升級為 <code>utf8mb4</code>（superset wins）</li>
<li>被轉換的那側欄位被包在函數裡 → B-Tree 索引無法使用</li>
</ol>
<h3 id="如何提前發現？"><a href="#如何提前發現？" class="headerlink" title="如何提前發現？"></a>如何提前發現？</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 檢查 JOIN 兩側的 charset 和 collation</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> table_a <span class="keyword">LIKE</span> <span class="string">&#x27;join_column&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> table_b <span class="keyword">LIKE</span> <span class="string">&#x27;join_column&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. EXPLAIN 後看 SHOW WARNINGS</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> ... ;</span><br><span class="line"><span class="keyword">SHOW</span> WARNINGS;</span><br><span class="line"><span class="comment">-- 看有沒有 convert() 或 collation 轉換</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 批量掃描整個資料庫中同名欄位的不一致</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    t1.TABLE_NAME <span class="keyword">AS</span> table_1,</span><br><span class="line">    t1.COLUMN_NAME <span class="keyword">AS</span> column_name,</span><br><span class="line">    t1.CHARACTER_SET_NAME <span class="keyword">AS</span> charset_1,</span><br><span class="line">    t1.COLLATION_NAME <span class="keyword">AS</span> collation_1,</span><br><span class="line">    t2.TABLE_NAME <span class="keyword">AS</span> table_2,</span><br><span class="line">    t2.CHARACTER_SET_NAME <span class="keyword">AS</span> charset_2,</span><br><span class="line">    t2.COLLATION_NAME <span class="keyword">AS</span> collation_2</span><br><span class="line"><span class="keyword">FROM</span> information_schema.COLUMNS t1</span><br><span class="line"><span class="keyword">JOIN</span> information_schema.COLUMNS t2</span><br><span class="line">    <span class="keyword">ON</span> t1.COLUMN_NAME <span class="operator">=</span> t2.COLUMN_NAME</span><br><span class="line">    <span class="keyword">AND</span> t1.TABLE_SCHEMA <span class="operator">=</span> t2.TABLE_SCHEMA</span><br><span class="line">    <span class="keyword">AND</span> t1.TABLE_NAME <span class="operator">&lt;</span> t2.TABLE_NAME</span><br><span class="line"><span class="keyword">WHERE</span> t1.TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;my_database&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> (t1.CHARACTER_SET_NAME <span class="operator">!=</span> t2.CHARACTER_SET_NAME</span><br><span class="line">         <span class="keyword">OR</span> t1.COLLATION_NAME <span class="operator">!=</span> t2.COLLATION_NAME);</span><br></pre></td></tr></table></figure>

<h3 id="整體建議"><a href="#整體建議" class="headerlink" title="整體建議"></a>整體建議</h3><p>由於這次是回去摸舊的系統, 現在較新的專案都推薦一律用 <code>utf8mb4</code>, 因為 MySQL 的 <code>utf8mb3</code> 只支援 3 字節，不是真正的 UTF-8, 然後在設計 DB 時也應該要有詳細的規章與規範, 來統一整個專案的 collation, 通常是推薦 <code>utf8mb4_0900_ai_ci</code> (語義正確的排序)或 <code>utf8mb4_bin</code>(精確比對).</p>
<p>若專案有 DBA 的話, 應該可以在 <code>my.cnf</code> 層級設定預設值, 避免依賴開發者記得在每張表指定, 但老實說多數中型團隊還不一定會有 DBA, 通常都是一個 <del>倒楣</del> 資深的工程師去兼顧, 另外我自己也推薦使用 flyway DB, 用 git 管理下方便在 Code Review 時檢查 DDL, 特別是跨團隊、跨服務的共用欄位.</p>
<p>不過我最推薦的還是在 CI pipeline 裡加一個 <code>lint step</code>, 跑上面 information_schema 的查詢，當有不一致就直接 fail build, 就可以提前發現問題.</p>
<hr>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>不得不說, 做 CRUD 久了, 真的會忘記一些在 SQL 上調優的流程與手法, 這次在測試的時候發現 <code>EXPLAIN</code> 的輸出跟我預期的不太一樣, 也比較了一下 MySQL 5.7 和 8 在 <code>EXPLAIN</code> 上的差別, 不僅重新複習了一下, 也學到了不少新知識.</p>
<p>最後是想感嘆, 一個團隊的運作, 往往細節決定成敗, 這次 Charset 和 Collation 的問題其實也反映出同一個專案在不同團隊下管理與承接時, 是否有細部的交接與比對, 還是只要能運作就好? 這些問題也會隨著時間逐漸增加解決難度, 比如我上面輕描淡寫的說使用 <code>ALTER TABLE</code> 修復, 但實際在生產環境, 這會需要評估資料的影響範圍, 執行與鎖表時間等, 那真的不如我們把問題扼殺在搖籃裡面.</p>
<p>如同 0.95 * 0.95 一樣, 長此以往, 終有一天會跌落我們能接受的及格線.</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/develop/">develop</a><a class="link-muted mr-2" rel="tag" href="/tags/DB/">DB</a><a class="link-muted mr-2" rel="tag" href="/tags/troll/">troll</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2026/02/09/redesign-flow/"><span class="level-item">一個代理掛號系統的流程 Redesign</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/PIX.png" alt="William Wu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">William Wu</p><p class="is-size-6 is-block">Hope you find solution here</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives/"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories/"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags/"><p class="title">34</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Williamrightone" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/Williamrightone"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="LinkedIn" href="https://www.linkedin.com/in/william-wu-786857142"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="CakeResume" href="https://www.cake.me/willy4543"><i class="fas fa-user-tie"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Design-Pattern/"><span class="level-start"><span class="level-item">Design Pattern</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Development/"><span class="level-start"><span class="level-item">Development</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Life/"><span class="level-start"><span class="level-item">Life</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Troll/"><span class="level-start"><span class="level-item">Troll</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/develop/"><span class="level-start"><span class="level-item">develop</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-02-14T07:38:40.000Z">2026-02-14</time></p><p class="title"><a href="/2026/02/14/table-collation-issue/">MySQL 調優 | Charset &amp; Collation 不一致導致的 JOIN 索引失效</a></p><p class="categories"><a href="/categories/develop/">develop</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-02-09T12:39:57.000Z">2026-02-09</time></p><p class="title"><a href="/2026/02/09/redesign-flow/">一個代理掛號系統的流程 Redesign</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-17T08:33:14.000Z">2026-01-17</time></p><p class="title"><a href="/2026/01/17/refactor-login-2/">DDD × Clean Architecture 的實戰筆記 2 | 當 Service 變成 Usecase</a></p><p class="categories"><a href="/categories/Design-Pattern/">Design Pattern</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-11T08:28:52.000Z">2026-01-11</time></p><p class="title"><a href="/2026/01/11/yingdao-rpa/">Automa | 影刀 RPA 測試與心得 (撰寫中...)</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-07T07:43:03.000Z">2026-01-07</time></p><p class="title"><a href="/2026/01/07/refactor-login/">DDD × Clean Architecture 的實戰筆記 | 一次登入流程帶來的架構重構</a></p><p class="categories"><a href="/categories/Design-Pattern/">Design Pattern</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2026/02/"><span class="level-start"><span class="level-item">February 2026</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2026/01/"><span class="level-start"><span class="level-item">January 2026</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/12/"><span class="level-start"><span class="level-item">December 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/11/"><span class="level-start"><span class="level-item">November 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/10/"><span class="level-start"><span class="level-item">October 2025</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/09/"><span class="level-start"><span class="level-item">September 2025</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/08/"><span class="level-start"><span class="level-item">August 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">June 2025</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/04/"><span class="level-start"><span class="level-item">April 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/03/"><span class="level-start"><span class="level-item">March 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/02/"><span class="level-start"><span class="level-item">February 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Agile/"><span class="tag">Agile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cache/"><span class="tag">Cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Casha/"><span class="tag">Casha</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Clean-Architecture/"><span class="tag">Clean Architecture</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DB/"><span class="tag">DB</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DDD/"><span class="tag">DDD</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Design-Pattern/"><span class="tag">Design Pattern</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DevOps/"><span class="tag">DevOps</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exception/"><span class="tag">Exception</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Garage/"><span class="tag">Garage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grafana/"><span class="tag">Grafana</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jmeter/"><span class="tag">Jmeter</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Life/"><span class="tag">Life</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MQ/"><span class="tag">MQ</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MinIO/"><span class="tag">MinIO</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Observation/"><span class="tag">Observation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RBAC/"><span class="tag">RBAC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RPA/"><span class="tag">RPA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rstar/"><span class="tag">Rstar</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3-Bucket/"><span class="tag">S3 Bucket</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SDLC/"><span class="tag">SDLC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SOLID/"><span class="tag">SOLID</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Saga/"><span class="tag">Saga</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Cloud/"><span class="tag">Spring Cloud</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-boot/"><span class="tag">Spring boot</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/System-Design/"><span class="tag">System Design</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chit-chat/"><span class="tag">chit-chat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/colorly/"><span class="tag">colorly</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/develop/"><span class="tag">develop</span><span class="tag">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flow/"><span class="tag">flow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/github-Actions/"><span class="tag">github Actions</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/troll/"><span class="tag">troll</span><span class="tag">2</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/PIX.png" alt="William Right&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2026 William Wu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2025</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>