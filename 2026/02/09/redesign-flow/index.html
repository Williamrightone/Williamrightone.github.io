<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>一個代理掛號系統的流程 Redesign - William Right&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="William Right&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="William Right&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="一月底的週末, 剛從菠菜離職的學弟約我吃了頓飯, 讓我目睹了一個純用 switch case 和 ad-hoc 打造的流程系統, 那晚我苦思良久..."><meta property="og:type" content="blog"><meta property="og:title" content="一個代理掛號系統的流程 Redesign"><meta property="og:url" content="https://williamrightone.github.io/2026/02/09/redesign-flow/"><meta property="og:site_name" content="William Right&#039;s Blog"><meta property="og:description" content="一月底的週末, 剛從菠菜離職的學弟約我吃了頓飯, 讓我目睹了一個純用 switch case 和 ad-hoc 打造的流程系統, 那晚我苦思良久..."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://williamrightone.github.io/img/refactor-flow/fearful.png"><meta property="article:published_time" content="2026-02-09T12:39:57.000Z"><meta property="article:modified_time" content="2026-02-12T13:18:56.362Z"><meta property="article:author" content="William Wu"><meta property="article:tag" content="develop"><meta property="article:tag" content="Spring boot"><meta property="article:tag" content="System Design"><meta property="article:tag" content="flow"><meta property="article:tag" content="troll"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://williamrightone.github.io/img/refactor-flow/fearful.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://williamrightone.github.io/2026/02/09/redesign-flow/"},"headline":"一個代理掛號系統的流程 Redesign","image":["https://williamrightone.github.io/img/refactor-flow/fearful.png"],"datePublished":"2026-02-09T12:39:57.000Z","dateModified":"2026-02-12T13:18:56.362Z","author":{"@type":"Person","name":"William Wu"},"publisher":{"@type":"Organization","name":"William Right's Blog","logo":{"@type":"ImageObject","url":"https://williamrightone.github.io/img/PIX.png"}},"description":"一月底的週末, 剛從菠菜離職的學弟約我吃了頓飯, 讓我目睹了一個純用 switch case 和 ad-hoc 打造的流程系統, 那晚我苦思良久..."}</script><link rel="canonical" href="https://williamrightone.github.io/2026/02/09/redesign-flow/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-S29D3Z45V4" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-S29D3Z45V4');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/PIX.png" alt="William Right&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/refactor-flow/fearful.png" alt="一個代理掛號系統的流程 Redesign"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2026-02-09T12:39:57.000Z" title="2026/2/9 下午8:39:57">2026-02-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2026-02-12T13:18:56.362Z" title="2026/2/12 下午9:18:56">2026-02-12</time></span><span class="level-item"><a class="link-muted" href="/categories/Development/">Development</a></span><span class="level-item">31 minutes read (About 4674 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">一個代理掛號系統的流程 Redesign</h1><div class="content"><p>一月底的週末, 剛從菠菜離職的學弟 K君 約我吃了頓飯(看來是年終到手了是吧), 和我分享了這一段時間的生活還有工作近況, 在職場上遇到的鬼故事之類的.</p>
<p>依稀記得當年一起在 SI 公司工作的時候, 遇上需求談不清楚又容易情緒管理失控的 SA, 我們還一起把 teams 的頭像掛上 Darkest Dungeon 裡的 <a target="_blank" rel="noopener" href="https://greatmultiverse.fandom.com/wiki/Iron_Crown">iron crown</a> (大致上就是負面 San 值的 Debuff, 當精神理智降低時會出現).</p>
<p>後來, 他和我分享了一段流程狀態的設計, 我僅看了一眼, 那段程式碼就像鐵皇冠的印記一樣深深烙印在我的眼睛, 把我拖入瘋狂的深淵.</p>
<p>(以下的範例經脫敏設計, 主要為了體現奇異的流程狀態設計, 可能會有一些不符合現實需求的地方)</p>
<hr>
<h2 id="一個關於醫院代理掛號的服務"><a href="#一個關於醫院代理掛號的服務" class="headerlink" title="一個關於醫院代理掛號的服務"></a>一個關於醫院代理掛號的服務</h2><p>K 老弟的需求大概是這樣, 他的系統提供一個 web base 的服務, 協助會員在指定的日期區間中, 對多家醫院進行網路掛號, 會員最後再從掛號成功的醫院中, 選擇一家看病.</p>
<p>而系統的流程則是如下:</p>
<ol>
<li>用戶輸入基本資料與上傳掛號文件</li>
<li>系統自動檢核文件, 若檢核失敗, 轉人工處理審核</li>
<li>審核通過, 系統啟動 RPA, 到各醫院的系統上進行掛號</li>
<li>若 RPA 失敗, 則轉人工操作掛號</li>
<li>掛號後, 系統會在會員的功能中顯示每個醫院的掛號狀態</li>
<li>會員選擇確切要掛號的醫院, 並取消其餘成功的掛號</li>
</ol>
<p>恩… 聽起來沒啥問題, 整個需求也很合理方便, 感覺我媽就會想註冊會員, 說他多好多好用, 然後叫我幫忙操作.</p>
<p>而真正的問題還是要撥開橘子才知道…, 這一段邏輯大概由三段程式組成:</p>
<ol>
<li>Enum 狀態機</li>
<li>Enum 事件與狀態</li>
<li>StateService</li>
</ol>
<h3 id="1-巢狀狀態機"><a href="#1-巢狀狀態機" class="headerlink" title="1. 巢狀狀態機"></a>1. 巢狀狀態機</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppointmentFlowManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Long</span> <span class="variable">flowTemplateId</span> <span class="operator">=</span> <span class="number">9487L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AppointmentStateEnum <span class="title function_">appointmentSubmit</span><span class="params">(AppointmentStateEnum currentState, AppointmentEvent event)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (currentState) &#123;</span><br><span class="line">            <span class="keyword">case</span> PENDING_DOCUMENT_VERIFICATION:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> DOC_VERIFICATION_SUBMIT:</span><br><span class="line">                        <span class="keyword">return</span> AppointmentStateEnum.DOCUMENT_VERIFYING;</span><br><span class="line">                    <span class="keyword">case</span> DOC_MANUAL_VERIFY_SUBMIT:</span><br><span class="line">                        <span class="keyword">return</span> AppointmentStateEnum.PENDING_HOSPITAL_RESPONSE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOCUMENT_VERIFYING:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> DOC_VERIFICATION_SUCCESS:</span><br><span class="line">                        <span class="keyword">return</span> PENDING_RPA_APPOINTMENT;</span><br><span class="line">                    <span class="keyword">case</span> DOC_VERIFICATION_FAILED:</span><br><span class="line">                        <span class="keyword">return</span> PENDING_MANUAL_VERIFICATION;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PENDING_MANUAL_VERIFICATION:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MANUAL_VERIFY_APPROVE:</span><br><span class="line">                        <span class="keyword">return</span> PENDING_RPA_APPOINTMENT;</span><br><span class="line">                    <span class="keyword">case</span> MANUAL_VERIFY_REJECT:</span><br><span class="line">                        <span class="keyword">return</span> APPOINTMENT_FAILED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PENDING_RPA_APPOINTMENT:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> RPA_START_APPOINTMENT:</span><br><span class="line">                        <span class="keyword">return</span> RPA_PROCESSING;</span><br><span class="line">                    <span class="keyword">case</span> MANUAL_APPOINTMENT_SUBMIT:</span><br><span class="line">                        <span class="keyword">return</span> PENDING_HOSPITAL_RESPONSE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RPA_PROCESSING:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> RPA_SUCCESS:</span><br><span class="line">                        <span class="keyword">return</span> PENDING_HOSPITAL_RESPONSE;</span><br><span class="line">                    <span class="keyword">case</span> RPA_FAILED:</span><br><span class="line">                        <span class="keyword">return</span> RPA_FAILED_PENDING_MANUAL;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RPA_FAILED_PENDING_MANUAL:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MANUAL_APPOINTMENT_SUBMIT:</span><br><span class="line">                        <span class="keyword">return</span> PENDING_HOSPITAL_RESPONSE;</span><br><span class="line">                    <span class="keyword">case</span> RPA_RETRY:</span><br><span class="line">                        <span class="keyword">return</span> RPA_PROCESSING;</span><br><span class="line">                    <span class="keyword">case</span> GIVE_UP_APPOINTMENT:</span><br><span class="line">                        <span class="keyword">return</span> APPOINTMENT_FAILED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PENDING_HOSPITAL_RESPONSE:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> HOSPITAL_APPROVE:</span><br><span class="line">                        <span class="keyword">return</span> APPOINTMENT_SUCCESS;</span><br><span class="line">                    <span class="keyword">case</span> HOSPITAL_REJECT:</span><br><span class="line">                        <span class="keyword">return</span> APPOINTMENT_FAILED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> APPOINTMENT_SUCCESS:</span><br><span class="line">                <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MEMBER_CONFIRM_HOSPITAL:</span><br><span class="line">                        <span class="keyword">return</span> APPOINTMENT_CONFIRMED;</span><br><span class="line">                    <span class="keyword">case</span> MEMBER_CANCEL_APPOINTMENT:</span><br><span class="line">                        <span class="keyword">return</span> APPOINTMENT_CANCELLED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> APPOINTMENT_CONFIRMED:</span><br><span class="line">                <span class="comment">// 終態，不再轉換</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> APPOINTMENT_CANCELLED:</span><br><span class="line">                <span class="comment">// 終態，不再轉換</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> APPOINTMENT_FAILED:</span><br><span class="line">                <span class="comment">// 終態，不再轉換</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;This appointment has been updated or submitted.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AppointmentStateEnum <span class="title function_">getInitialState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AppointmentStateEnum.PENDING_DOCUMENT_VERIFICATION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-狀態與事件-Enum"><a href="#2-狀態與事件-Enum" class="headerlink" title="2. 狀態與事件 Enum"></a>2. 狀態與事件 Enum</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AppointmentStateEnum</span> &#123;</span><br><span class="line">    PENDING_DOCUMENT_VERIFICATION(<span class="number">1L</span>, <span class="string">&quot;待文件驗證&quot;</span>),</span><br><span class="line">    DOCUMENT_VERIFYING(<span class="number">2L</span>, <span class="string">&quot;文件驗證中&quot;</span>),</span><br><span class="line">    PENDING_MANUAL_VERIFICATION(<span class="number">3L</span>, <span class="string">&quot;待人工審核&quot;</span>),</span><br><span class="line">    PENDING_RPA_APPOINTMENT(<span class="number">4L</span>, <span class="string">&quot;待RPA掛號&quot;</span>),</span><br><span class="line">    RPA_PROCESSING(<span class="number">5L</span>, <span class="string">&quot;RPA處理中&quot;</span>),</span><br><span class="line">    RPA_FAILED_PENDING_MANUAL(<span class="number">6L</span>, <span class="string">&quot;RPA失敗待人工&quot;</span>),</span><br><span class="line">    PENDING_HOSPITAL_RESPONSE(<span class="number">7L</span>, <span class="string">&quot;等待醫院回應&quot;</span>),</span><br><span class="line">    APPOINTMENT_SUCCESS(<span class="number">8L</span>, <span class="string">&quot;掛號成功&quot;</span>),</span><br><span class="line">    APPOINTMENT_FAILED(<span class="number">9L</span>, <span class="string">&quot;掛號失敗&quot;</span>),</span><br><span class="line">    APPOINTMENT_CONFIRMED(<span class="number">10L</span>, <span class="string">&quot;已確認掛號&quot;</span>),</span><br><span class="line">    APPOINTMENT_CANCELLED(<span class="number">11L</span>, <span class="string">&quot;已取消掛號&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long code;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AppointmentStateEnum <span class="title function_">getByCode</span><span class="params">(Long code)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (AppointmentStateEnum state : values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (state.getCode().equals(code)) &#123;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown state code: &quot;</span> + code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// constructor, getter...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AppointmentEvent</span> &#123;</span><br><span class="line">    DOC_VERIFICATION_SUBMIT,</span><br><span class="line">    DOC_VERIFICATION_SUCCESS,</span><br><span class="line">    DOC_VERIFICATION_FAILED,</span><br><span class="line">    DOC_MANUAL_VERIFY_SUBMIT,</span><br><span class="line">    MANUAL_VERIFY_APPROVE,</span><br><span class="line">    MANUAL_VERIFY_REJECT,</span><br><span class="line">    RPA_START_APPOINTMENT,</span><br><span class="line">    RPA_SUCCESS,</span><br><span class="line">    RPA_FAILED,</span><br><span class="line">    RPA_RETRY,</span><br><span class="line">    MANUAL_APPOINTMENT_SUBMIT,</span><br><span class="line">    HOSPITAL_APPROVE,</span><br><span class="line">    HOSPITAL_REJECT,</span><br><span class="line">    MEMBER_CONFIRM_HOSPITAL,</span><br><span class="line">    MEMBER_CANCEL_APPOINTMENT,</span><br><span class="line">    GIVE_UP_APPOINTMENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MemberAppointmentStatusEnum</span> &#123;</span><br><span class="line">    PENDING_VERIFICATION(<span class="string">&quot;待驗證&quot;</span>),</span><br><span class="line">    PROCESSING(<span class="string">&quot;處理中&quot;</span>),</span><br><span class="line">    PENDING_MEMBER_SELECTION(<span class="string">&quot;待選擇醫院&quot;</span>),</span><br><span class="line">    APPOINTMENT_CONFIRMED(<span class="string">&quot;已確認掛號&quot;</span>),</span><br><span class="line">    ALL_FAILED(<span class="string">&quot;全部失敗&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="comment">// constructor, getter...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-StateService"><a href="#3-StateService" class="headerlink" title="3. StateService"></a>3. StateService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppointmentStateService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HospitalAppointmentMapper hospitalAppointmentMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AppointmentFlowManager flowManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新掛號單狀態並同步會員狀態</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateAppointmentState</span><span class="params">(String appointmentNo, AppointmentEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查詢當前掛號單</span></span><br><span class="line">        <span class="type">HospitalAppointment</span> <span class="variable">appointment</span> <span class="operator">=</span> hospitalAppointmentMapper.selectOne(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;HospitalAppointment&gt;().eq(<span class="string">&quot;appointment_no&quot;</span>, appointmentNo)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 取得當前狀態</span></span><br><span class="line">        <span class="type">AppointmentStateEnum</span> <span class="variable">currentState</span> <span class="operator">=</span> AppointmentStateEnum.getByCode(appointment.getState());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 計算下一個狀態</span></span><br><span class="line">        <span class="type">AppointmentStateEnum</span> <span class="variable">nextState</span> <span class="operator">=</span> flowManager.appointmentSubmit(currentState, event);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 更新掛號單狀態</span></span><br><span class="line">        appointment.setState(nextState.getCode());</span><br><span class="line">        appointment.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        hospitalAppointmentMapper.updateById(appointment);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 處理特殊業務邏輯</span></span><br><span class="line">        <span class="built_in">this</span>.handleSpecialLogic(appointment, nextState);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. 計算並更新會員總狀態</span></span><br><span class="line">        <span class="built_in">this</span>.updateMemberStatus(appointment.getMemberId(), appointment.getAppointmentBatchNo());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 處理特殊業務</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleSpecialLogic</span><span class="params">(HospitalAppointment appointment, AppointmentStateEnum nextState)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果確認掛號，取消其他成功的掛號</span></span><br><span class="line">        <span class="keyword">if</span> (nextState.equals(AppointmentStateEnum.APPOINTMENT_CONFIRMED)) &#123;</span><br><span class="line">            List&lt;HospitalAppointment&gt; otherAppointments = hospitalAppointmentMapper.selectList(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;HospitalAppointment&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;member_id&quot;</span>, appointment.getMemberId())</span><br><span class="line">                    .eq(<span class="string">&quot;appointment_batch_no&quot;</span>, appointment.getAppointmentBatchNo())</span><br><span class="line">                    .ne(<span class="string">&quot;appointment_no&quot;</span>, appointment.getAppointmentNo())</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 檢查是否已有其他確認的掛號</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasConfirmed</span> <span class="operator">=</span> otherAppointments.stream()</span><br><span class="line">                .anyMatch(apt -&gt; apt.getState().equals(AppointmentStateEnum.APPOINTMENT_CONFIRMED.getCode()));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (hasConfirmed) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;You have already confirmed another hospital appointment.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 取消其他成功的掛號</span></span><br><span class="line">            otherAppointments.stream()</span><br><span class="line">                .filter(apt -&gt; apt.getState().equals(AppointmentStateEnum.APPOINTMENT_SUCCESS.getCode()))</span><br><span class="line">                .forEach(apt -&gt; &#123;</span><br><span class="line">                    apt.setState(AppointmentStateEnum.APPOINTMENT_CANCELLED.getCode());</span><br><span class="line">                    apt.setCancelReason(<span class="string">&quot;Member confirmed another hospital&quot;</span>);</span><br><span class="line">                    apt.setCancelTime(LocalDateTime.now());</span><br><span class="line">                    hospitalAppointmentMapper.updateById(apt);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 呼叫醫院 API 取消掛號</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        hospitalApiService.cancelAppointment(apt.getAppointmentNo());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;Failed to cancel appointment: &#123;&#125;&quot;</span>, apt.getAppointmentNo(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算並更新會員總狀態</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateMemberStatus</span><span class="params">(String memberId, String appointmentBatchNo)</span> &#123;</span><br><span class="line">        <span class="comment">// 查詢該會員所有掛號單</span></span><br><span class="line">        List&lt;HospitalAppointment&gt; appointments = hospitalAppointmentMapper.selectList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;HospitalAppointment&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;member_id&quot;</span>, memberId)</span><br><span class="line">                .eq(<span class="string">&quot;appointment_batch_no&quot;</span>, appointmentBatchNo)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        List&lt;Long&gt; stateList = appointments.stream().map(HospitalAppointment::getState).collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="type">MemberAppointmentStatusEnum</span> <span class="variable">memberStatus</span> <span class="operator">=</span> <span class="built_in">this</span>.calculateMemberStatus(stateList);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新會員狀態到某個地方... 這裡不贅述</span></span><br><span class="line">        log.info(<span class="string">&quot;Member &#123;&#125; batch &#123;&#125; status: &#123;&#125;&quot;</span>, memberId, appointmentBatchNo, memberStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算會員總狀態</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> MemberAppointmentStatusEnum <span class="title function_">calculateMemberStatus</span><span class="params">(List&lt;Long&gt; stateList)</span> &#123;</span><br><span class="line">        <span class="comment">// 全部失敗或取消</span></span><br><span class="line">        <span class="keyword">if</span> (stateList.stream().allMatch(state -&gt; </span><br><span class="line">            state.equals(<span class="number">9L</span>) || state.equals(<span class="number">11L</span>))) &#123;  <span class="comment">// 9=FAILED, 11=CANCELLED</span></span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatusEnum.ALL_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 已確認</span></span><br><span class="line">        <span class="keyword">if</span> (stateList.stream().anyMatch(state -&gt; state.equals(<span class="number">10L</span>))) &#123;  <span class="comment">// 10=CONFIRMED</span></span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatusEnum.APPOINTMENT_CONFIRMED;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 待選擇醫院 (至少一個成功)</span></span><br><span class="line">        <span class="keyword">if</span> (stateList.stream().anyMatch(state -&gt; state.equals(<span class="number">8L</span>))) &#123;  <span class="comment">// 8=SUCCESS</span></span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatusEnum.PENDING_MEMBER_SELECTION;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 待驗證 (所有都還在最初狀態)</span></span><br><span class="line">        <span class="keyword">if</span> (stateList.stream().allMatch(state -&gt; </span><br><span class="line">            state.equals(<span class="number">1L</span>) || state.equals(<span class="number">2L</span>) || state.equals(<span class="number">3L</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatusEnum.PENDING_VERIFICATION;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 其他情況都是處理中</span></span><br><span class="line">        <span class="keyword">return</span> MemberAppointmentStatusEnum.PROCESSING;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="剝開橘子"><a href="#剝開橘子" class="headerlink" title="剝開橘子"></a>剝開橘子</h2><p>老實說, 基於程式能跑就不要動他的原則, 如果是我自己在工作內看到這些程式, 應該內心會毫無波瀾, 但剛好有機會就來嘗試 redesign 一下, 我們先盤一盤目前有的問題．</p>
<h3 id="1-巢狀-switch"><a href="#1-巢狀-switch" class="headerlink" title="1. 巢狀 switch"></a>1. 巢狀 switch</h3><p>AppointmentFlowManager 裡那坨巢狀 switch, 雖然照著看還是能理解每個接續的步驟, 但每一次更新，就需要連帶調整多個地方.</p>
<p>舉個實際的需求:</p>
<blockquote>
<p>文件驗證要多一段 AI 初審，AI 過了就直接走 RPA，AI 沒過才轉人工</p>
</blockquote>
<p>我就會需要改:</p>
<ol>
<li>AppointmentStateEnum：加一個 AI_REVIEWING 狀態</li>
<li>AppointmentEvent：加 AI_REVIEW_SUCCESS、AI_REVIEW_FAILED 兩個事件</li>
<li>AppointmentFlowManager：在 switch 裡加 AI_REVIEWING 的 case，同時改 DOCUMENT_VERIFYING 的 transition 指向</li>
<li>StateService.handleSpecialLogic：如果 AI 審核有特殊邏輯，再補一段 if</li>
<li>calculateMemberStatus：更新判斷條件 (而且這裡用的是 magic number)</li>
</ol>
<p>五個地方，散落在三個 class 裡, 漏改任何一處, 要不是拋一個 ErrorMsg, 就是最終狀態不對, 這其實違反了 OCP(開放封閉原則), 對擴展開放、對修改封閉. 好的狀態機設計，加一個狀態應該只需要單純的新增, 不用到處改.</p>
<h3 id="2-用錯聚合"><a href="#2-用錯聚合" class="headerlink" title="2. 用錯聚合"></a>2. 用錯聚合</h3><p>我個人覺得這才是核心的問題所在, 需求是<strong>會員對多家醫院掛號，最後選一家，其餘取消</strong>, 這代表真正的業務主體是<strong>這一批掛號(Batch)</strong>，不是某一家醫院的掛號單。</p>
<p>但原始設計把所有邏輯都塞在 HospitalAppointment(單筆掛號單)的狀態流轉裡，確認後取消其他這條跨單規則被硬擠進 StateService.handleSpecialLogic()內:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextState.equals(AppointmentStateEnum.APPOINTMENT_CONFIRMED)) &#123;</span><br><span class="line">    <span class="comment">// 查出其他掛號單</span></span><br><span class="line">    <span class="comment">// 檢查有沒有已確認的</span></span><br><span class="line">    <span class="comment">// 取消其他成功的</span></span><br><span class="line">    <span class="comment">// 呼叫醫院 API</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這會造成並發不安全, 以及規則散落, 只能 confirm 一家醫院掛號是核心業務規則，它應該在 domain 裡被集中守護，而不是藏在 service 的某個 if 裡。今天一個新人接手(或是其他部門的同事來支援)，會大幅度提高理解的時間, 最可怕的是修正後自己的業務可行, 但其他的業務反而被改壞了。</p>
<p>最後是外部 API 在 transaction 裡, 取消其他掛號時還要 call 醫院的取消 API，而這段 code 在 @Transactional 裡面, 如果 API call 超時 30 秒，你的 DB connection 就被 hold 住 30 秒；如果 API call 失敗，留下的選擇只有整個 transaction rollback.</p>
<h3 id="3-God-Service"><a href="#3-God-Service" class="headerlink" title="3. God Service"></a>3. God Service</h3><p>這個是 java 開發的老毛病了, 一個 Service Method 扛一片天, 有沒有寫 unit test 一看就知道(如果是我也不寫, 自測 happy path 剩下的交給 QA)</p>
<blockquote>
<p>但是他開發交付可以很快 (謎之聲)</p>
</blockquote>
<p>看看 updateAppointmentState() 到底做了多少事:</p>
<ol>
<li>載入掛號單</li>
<li>狀態遷移</li>
<li>DB update</li>
<li>特殊規則（confirm 後取消其他）</li>
<li>呼叫外部 hospital API</li>
<li>計算會員總狀態</li>
<li>更新會員狀態</li>
</ol>
<p>七件事，一個 method，一個 @Transactional。這是典型的 God Service, 什麼都知道、什麼都做，正常測試的時候會需要 mock DB、mock 外部 API、mock 各種狀態分支，寫一個 unit test 可能比寫主邏輯還累。而且一旦未來要加 outbox pattern、事件通知、SLA 超時處理，程式通通落在這個 method 內，每次改都有機會影響既有邏輯(我真是最怕最怕就是這種事情)。</p>
<p>題外話, K 老弟當時就是在前面的 handleSpecialLogic 內補了一個 if, 他自己的流程完全正常, 但 calculateMemberStatus 直接破一個流程漏洞, 原先可以的流程直接亂掉, test 環境民怨四起, K 老弟只好退版, 在他自己的環境內去盤各種情境.</p>
<p>到這裡我們可以做個小結, 這段程式碼的問題根因是巢狀 switch 難擴展, 狀態轉換沒有被獨立封裝, 加需求就要改多處，漏改就爆開(還不是爆自己的), code 變動時靜默出錯, 跨單規則塞在單筆流程聚合根選錯(應該是 Batch), 並發不安全、規則散落 God Service, 沒有分離 application&#x2F;domain&#x2F;infrastructure 測試痛苦、交易邊界混亂.</p>
<p>盤點出問題在哪之後，來看看怎麼改。</p>
<h2 id="重構思路"><a href="#重構思路" class="headerlink" title="重構思路"></a>重構思路</h2><p>核心思路其實就是 SOLID, 讓每一層只做自己該做的事。</p>
<p>首先是狀態轉換, <em>從巢狀 switch 到宣告式 Transition Map</em>.</p>
<p>原本的 AppointmentFlowManager 用巢狀 switch 表達狀態轉換，邏輯上沒有錯，但每次擴展都要改 switch 本體。我們應該要讓<em>狀態 + 事件 -&gt; 下一個狀態</em>這件事可以用宣告的方式來定義，也就是新增 transition 只要加一行，不用改既有程式碼.</p>
<p>這時年薪 200W up 的鄉民應該都想到了 State Pattern, GoF 經典款，藉由每個狀態獨立建一個 class，各自實作 onEvent() 方法, 這完全符合 OCP, 加新狀態就加新 class，不用改舊 code.</p>
<p>但是這個案例有一個疑慮, 就是我們可能會建立大量相似的 state class, 以這個掛號為例就有 11 個 class 要建立, 一看每個狀態的 handler 內實際就是一個 switch expression，只把事件對應到下一個狀態，沒有任何狀態特有的行為（例如進入時啟動排程、離開時清理資源等）這樣等於我只是把一個集中的 switch 拆成了 11 個分散的 switch 罷了。</p>
<p>State Pattern 最有價值的地方是當不同狀態有不同的行為邏輯，例如 <strong>RPA 處理中</strong>進入時要啟動 RPA scheduler，<strong>等待醫院回應</strong>進入時要設定 24 小時超時計時器。如果狀態真的有這種差異化行為，那 State Pattern 是正確的選擇。</p>
<p>但如果狀態轉換就是純粹的 A + event -&gt; B 映射，那用一張宣告式的 transition table 就夠了，而且更加一目了然.</p>
<p>Transition Map 的做法是用一個 <code>Map&lt;(State, Event), NextState&gt;</code> 把所有合法的狀態轉移集中定義:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppointmentTransitions</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;StateEventKey, HospitalAppointmentState&gt; TABLE = Map.ofEntries(</span><br><span class="line">        entry(key(PENDING_DOCUMENT_VERIFICATION, DOC_VERIFICATION_SUBMIT),    DOCUMENT_VERIFYING),</span><br><span class="line">        entry(key(PENDING_DOCUMENT_VERIFICATION, DOC_MANUAL_VERIFY_SUBMIT),   PENDING_HOSPITAL_RESPONSE),</span><br><span class="line"></span><br><span class="line">        entry(key(DOCUMENT_VERIFYING, DOC_VERIFICATION_SUCCESS),  PENDING_RPA_APPOINTMENT),</span><br><span class="line">        entry(key(DOCUMENT_VERIFYING, DOC_VERIFICATION_FAILED),   PENDING_MANUAL_VERIFICATION),</span><br><span class="line"></span><br><span class="line">        entry(key(PENDING_MANUAL_VERIFICATION, MANUAL_VERIFY_APPROVE), PENDING_RPA_APPOINTMENT),</span><br><span class="line">        entry(key(PENDING_MANUAL_VERIFICATION, MANUAL_VERIFY_REJECT),  APPOINTMENT_FAILED),</span><br><span class="line"></span><br><span class="line">        entry(key(PENDING_RPA_APPOINTMENT, RPA_START_APPOINTMENT),      RPA_PROCESSING),</span><br><span class="line">        entry(key(PENDING_RPA_APPOINTMENT, MANUAL_APPOINTMENT_SUBMIT),  PENDING_HOSPITAL_RESPONSE),</span><br><span class="line"></span><br><span class="line">        entry(key(RPA_PROCESSING, RPA_SUCCESS),  PENDING_HOSPITAL_RESPONSE),</span><br><span class="line">        entry(key(RPA_PROCESSING, RPA_FAILED),   RPA_FAILED_PENDING_MANUAL),</span><br><span class="line"></span><br><span class="line">        entry(key(RPA_FAILED_PENDING_MANUAL, MANUAL_APPOINTMENT_SUBMIT), PENDING_HOSPITAL_RESPONSE),</span><br><span class="line">        entry(key(RPA_FAILED_PENDING_MANUAL, RPA_RETRY),                 RPA_PROCESSING),</span><br><span class="line">        entry(key(RPA_FAILED_PENDING_MANUAL, GIVE_UP_APPOINTMENT),       APPOINTMENT_FAILED),</span><br><span class="line"></span><br><span class="line">        entry(key(PENDING_HOSPITAL_RESPONSE, HOSPITAL_APPROVE), APPOINTMENT_SUCCESS),</span><br><span class="line">        entry(key(PENDING_HOSPITAL_RESPONSE, HOSPITAL_REJECT),  APPOINTMENT_FAILED),</span><br><span class="line"></span><br><span class="line">        entry(key(APPOINTMENT_SUCCESS, MEMBER_CONFIRM_HOSPITAL),    APPOINTMENT_CONFIRMED),</span><br><span class="line">        entry(key(APPOINTMENT_SUCCESS, MEMBER_CANCEL_APPOINTMENT),  APPOINTMENT_CANCELLED)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HospitalAppointmentState <span class="title function_">next</span><span class="params">(HospitalAppointmentState current, AppointmentEvent event)</span> &#123;</span><br><span class="line">        <span class="type">HospitalAppointmentState</span> <span class="variable">next</span> <span class="operator">=</span> TABLE.get(key(current, event));</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;No transition defined: &quot;</span> + current + <span class="string">&quot; + &quot;</span> + event);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">record</span> <span class="title class_">StateEventKey</span><span class="params">(HospitalAppointmentState state, AppointmentEvent event)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StateEventKey <span class="title function_">key</span><span class="params">(HospitalAppointmentState s, AppointmentEvent e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StateEventKey</span>(s, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>對比一下差異：</p>
<table>
<thead>
<tr>
<th></th>
<th>巢狀 switch</th>
<th>Transition Map</th>
</tr>
</thead>
<tbody><tr>
<td>新增一組 transition</td>
<td>找到對應的 case，插入新 case</td>
<td>加一行 <code>entry(...)</code></td>
</tr>
<tr>
<td>一覽全部合法路徑</td>
<td>要展開整個 switch 慢慢看</td>
<td>一張表直接看完</td>
</tr>
<tr>
<td>不小心漏寫某個 transition</td>
<td>掉進外層 break，拋模糊 exception</td>
<td><code>TABLE.get()</code> 回傳 null，明確報錯</td>
</tr>
<tr>
<td>未來需要狀態有行為差異</td>
<td>改 switch（又要動原本的）</td>
<td>可以針對特定狀態抽出 handler，漸進重構</td>
</tr>
</tbody></table>
<p>而且這張表天生就是<strong>可測試的</strong>, 這時就可以寫一個 parameterized test 把每組 <code>(state, event, expectedNext)</code> 跑一遍，確保所有 transition 都有被覆蓋。</p>
<h3 id="聚合根歸位"><a href="#聚合根歸位" class="headerlink" title="聚合根歸位"></a>聚合根歸位</h3><p>原本確認後取消其他的邏輯散落在 <code>StateService.handleSpecialLogic()</code> 裡，我們把它收進 <code>AppointmentBatch</code> 這個聚合根：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppointmentBatch</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String batchNo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String memberId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;HospitalAppointment&gt; appointments;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> version;  <span class="comment">// 樂觀鎖</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 會員確認某家醫院：只能 confirm 一家，其餘成功的標記取消</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BatchConfirmResult <span class="title function_">confirmHospital</span><span class="params">(String targetAppointmentNo)</span> &#123;</span><br><span class="line">        <span class="comment">// 1：不能重複確認</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">alreadyConfirmed</span> <span class="operator">=</span> appointments.stream().anyMatch(HospitalAppointment::isConfirmed);</span><br><span class="line">        <span class="keyword">if</span> (alreadyConfirmed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;Already confirmed another hospital in batch &quot;</span> + batchNo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2：目標必須是掛號成功的</span></span><br><span class="line">        <span class="type">HospitalAppointment</span> <span class="variable">target</span> <span class="operator">=</span> findAppointment(targetAppointmentNo);</span><br><span class="line">        <span class="keyword">if</span> (!target.isSuccess()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;Cannot confirm: appointment is &quot;</span> + target.getState());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 執行：confirm target, cancel others</span></span><br><span class="line">        target.apply(HospitalAppointmentState.APPOINTMENT_CONFIRMED);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; cancelledNos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (HospitalAppointment a : appointments) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!a.getAppointmentNo().equals(targetAppointmentNo) &amp;&amp; a.isSuccess()) &#123;</span><br><span class="line">                a.cancelBecauseMemberConfirmedOther();</span><br><span class="line">                cancelledNos.add(a.getAppointmentNo());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BatchConfirmResult</span>(cancelledNos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算會員層級的總狀態</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> MemberAppointmentStatus <span class="title function_">calculateMemberStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (appointments.stream().anyMatch(HospitalAppointment::isConfirmed)) &#123;</span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatus.CONFIRMED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (appointments.stream().anyMatch(a -&gt;</span><br><span class="line">                a.getState() == HospitalAppointmentState.APPOINTMENT_SUCCESS)) &#123;</span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatus.PENDING_SELECTION;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (appointments.stream().allMatch(a -&gt; a.getState().isTerminal())) &#123;</span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatus.ALL_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (appointments.stream().allMatch(a -&gt;</span><br><span class="line">                a.getState() == HospitalAppointmentState.PENDING_DOCUMENT_VERIFICATION</span><br><span class="line">             || a.getState() == HospitalAppointmentState.DOCUMENT_VERIFYING</span><br><span class="line">             || a.getState() == HospitalAppointmentState.PENDING_MANUAL_VERIFICATION)) &#123;</span><br><span class="line">            <span class="keyword">return</span> MemberAppointmentStatus.PENDING_VERIFICATION;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MemberAppointmentStatus.PROCESSING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HospitalAppointment <span class="title function_">findAppointment</span><span class="params">(String appointmentNo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> appointments.stream()</span><br><span class="line">            .filter(a -&gt; a.getAppointmentNo().equals(appointmentNo))</span><br><span class="line">            .findFirst()</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                <span class="string">&quot;Appointment not found: &quot;</span> + appointmentNo));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">BatchConfirmResult</span><span class="params">(List&lt;String&gt; cancelledAppointmentNos)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// constructor, getters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意幾個重點：</p>
<p><strong><code>calculateMemberStatus()</code> 不再有 magic number</strong>, 判斷全部透過 enum 比對，而 <code>isTerminal()</code> 這種語意化方法定義在 enum 自身, 等於狀態的語意由狀態自己說了算，service 不需要知道哪些 code 代表終態.</p>
<p><strong>只能 confirm 一家和 confirm 後取消其他家掛號被封裝在同一個方法裡</strong>。任何人要做 confirm，都必須通過 <code>AppointmentBatch.confirmHospital()</code>執行，沒有繞過的空間.</p>
<h3 id="UseCase"><a href="#UseCase" class="headerlink" title="UseCase"></a>UseCase</h3><p>最後，再把 Application Layer 的 UseCase 從 God Service 拉出來瘦身:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateAppointmentStateUseCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AppointmentRepository appointmentRepo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BatchRepository batchRepo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DomainEventPublisher eventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String appointmentNo, AppointmentEvent event)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (event == AppointmentEvent.MEMBER_CONFIRM_HOSPITAL) &#123;</span><br><span class="line">            <span class="comment">// confirm 是批次操作，交給聚合根</span></span><br><span class="line">            handleConfirm(appointmentNo);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一般狀態轉換：單筆</span></span><br><span class="line">        <span class="type">HospitalAppointment</span> <span class="variable">appointment</span> <span class="operator">=</span> appointmentRepo.getByNo(appointmentNo);</span><br><span class="line">        <span class="type">HospitalAppointmentState</span> <span class="variable">next</span> <span class="operator">=</span> AppointmentTransitions.next(appointment.getState(), event);</span><br><span class="line">            appointment.apply(next);</span><br><span class="line">            appointmentRepo.save(appointment);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新會員總狀態（透過事件，非同步也可以）</span></span><br><span class="line">            publishMemberStatusUpdate(appointment.getBatchNo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleConfirm</span><span class="params">(String appointmentNo)</span> &#123;</span><br><span class="line">        <span class="type">HospitalAppointment</span> <span class="variable">appointment</span> <span class="operator">=</span> appointmentRepo.getByNo(appointmentNo);</span><br><span class="line">        <span class="type">AppointmentBatch</span> <span class="variable">batch</span> <span class="operator">=</span> batchRepo.getByBatchNo(appointment.getBatchNo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 聚合根統一處理 confirm + cancel others</span></span><br><span class="line">        AppointmentBatch.<span class="type">BatchConfirmResult</span> <span class="variable">result</span> <span class="operator">=</span> batch.confirmHospital(appointmentNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 持久化整個 batch（含樂觀鎖檢查）</span></span><br><span class="line">        batchRepo.save(batch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需要取消的掛號，發 domain event，在交易外處理</span></span><br><span class="line">        <span class="keyword">for</span> (String cancelNo : result.cancelledAppointmentNos()) &#123;</span><br><span class="line">            eventPublisher.publish(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CancelHospitalAppointmentRequested</span>(cancelNo));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        publishMemberStatusUpdate(batch.getBatchNo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishMemberStatusUpdate</span><span class="params">(String batchNo)</span> &#123;</span><br><span class="line">        <span class="type">AppointmentBatch</span> <span class="variable">batch</span> <span class="operator">=</span> batchRepo.getByBatchNo(batchNo);</span><br><span class="line">        <span class="type">MemberAppointmentStatus</span> <span class="variable">status</span> <span class="operator">=</span> batch.calculateMemberStatus();</span><br><span class="line">        eventPublisher.publish(<span class="keyword">new</span> <span class="title class_">MemberStatusChanged</span>(batch.getMemberId(), batchNo, status));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>對比一下原本的 God Service，這裡的職責切分是：</p>
<table>
<thead>
<tr>
<th>Class</th>
<th>職責</th>
</tr>
</thead>
<tbody><tr>
<td><code>AppointmentTransitions</code></td>
<td>狀態 + 事件 -&gt; 下一個狀態</td>
</tr>
<tr>
<td><code>HospitalAppointment</code></td>
<td>單筆掛號的狀態管理</td>
</tr>
<tr>
<td><code>AppointmentBatch</code></td>
<td>只能 confirm 一家、取消其他、算會員總狀態</td>
</tr>
<tr>
<td><code>UseCase</code></td>
<td>編排流程: 載入 -&gt; 呼叫 domain -&gt; 持久化 -&gt; 發事件</td>
</tr>
<tr>
<td><code>CancelHandler</code>（事件消費者）</td>
<td>在交易外呼叫醫院取消 API，可重試、可補償</td>
</tr>
</tbody></table>
<p>外部 API 不再出現在 <code>@Transactional</code> 裡。取消掛號透過 Domain Event 發出，由獨立的 handler（可以是 MQ consumer 或 scheduled worker）在交易外執行，失敗可以重試、也可以進 dead-letter queue, 這裡就不贅述了.</p>
<hr>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>前幾天在瘦身 Rstar 專案的時候, 光是一個 Login 就搞得我焦頭爛額, 那天跟 K 老弟談到這件事時不知不覺聊了很多(酒也越喝越多, 聲音開始不受控制), K 老弟其實也有考慮要用 State Pattern 來重構, 但他建立到第四個 state class 的時候就開始懷疑自己了．</p>
<p>他跟我抱怨起前公司的架構和流程有多不健全, 說懷念當時一起在 SI 的時光, 雖然客戶的需求一直改設計一直變動, 但是所有的需求都會經過內化與評估後才轉化為開發規格, 現在各種場景都是靠幻想, 恍惚之間, 我看到了他頭頂上的鐵王冠…</p>
<blockquote>
<p>啊, 原來他的 San 值歸零了啊…</p>
</blockquote>
<p> <img src="/../img/refactor-flow/irrational.png" alt="Madness... our old friend"></p>
<p>自從加入軟體業, 我發現最大的問題不是不知道怎麼做, 而是不知道要做什麼, 尤其是現在有 AI 的幫助, 只要能寫出詳細的 prompt, 多數的問題都能夠被解決. </p>
<p>因此我其實不太喜歡評價別人的程式碼好壞, 因為我們無從知道開發當下的處境, 就拿 K 老弟處理的 巢狀 switch, 也許當時設計時預設就只會有兩三個流程, 需求文件就幾行字, 又或許只有半天的開發時間, <del>也許公司給的 pay 很差</del>, 在這種情況之下, God Service &amp; 巢狀 switch 反而成了最佳解, 而這也就是一個 Legacy Code 的誕生.</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/develop/">develop</a><a class="link-muted mr-2" rel="tag" href="/tags/Spring-boot/">Spring boot</a><a class="link-muted mr-2" rel="tag" href="/tags/System-Design/">System Design</a><a class="link-muted mr-2" rel="tag" href="/tags/flow/">flow</a><a class="link-muted mr-2" rel="tag" href="/tags/troll/">troll</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2026/01/17/refactor-login-2/"><span class="level-item">DDD × Clean Architecture 的實戰筆記 2 | 當 Service 變成 Usecase</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/PIX.png" alt="William Wu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">William Wu</p><p class="is-size-6 is-block">Hope you find solution here</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives/"><p class="title">24</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories/"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags/"><p class="title">34</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Williamrightone" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/Williamrightone"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="LinkedIn" href="https://www.linkedin.com/in/william-wu-786857142"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="CakeResume" href="https://www.cake.me/willy4543"><i class="fas fa-user-tie"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Design-Pattern/"><span class="level-start"><span class="level-item">Design Pattern</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Development/"><span class="level-start"><span class="level-item">Development</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Life/"><span class="level-start"><span class="level-item">Life</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Troll/"><span class="level-start"><span class="level-item">Troll</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-02-09T12:39:57.000Z">2026-02-09</time></p><p class="title"><a href="/2026/02/09/redesign-flow/">一個代理掛號系統的流程 Redesign</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-17T08:33:14.000Z">2026-01-17</time></p><p class="title"><a href="/2026/01/17/refactor-login-2/">DDD × Clean Architecture 的實戰筆記 2 | 當 Service 變成 Usecase</a></p><p class="categories"><a href="/categories/Design-Pattern/">Design Pattern</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-11T08:28:52.000Z">2026-01-11</time></p><p class="title"><a href="/2026/01/11/yingdao-rpa/">Automa | 影刀 RPA 測試與心得 (撰寫中...)</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-07T07:43:03.000Z">2026-01-07</time></p><p class="title"><a href="/2026/01/07/refactor-login/">DDD × Clean Architecture 的實戰筆記 | 一次登入流程帶來的架構重構</a></p><p class="categories"><a href="/categories/Design-Pattern/">Design Pattern</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-01-01T10:39:57.000Z">2026-01-01</time></p><p class="title"><a href="/2026/01/01/about-retry/">關於 api retry 的實作方法, 和開發心得</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2026/02/"><span class="level-start"><span class="level-item">February 2026</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2026/01/"><span class="level-start"><span class="level-item">January 2026</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/12/"><span class="level-start"><span class="level-item">December 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/11/"><span class="level-start"><span class="level-item">November 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/10/"><span class="level-start"><span class="level-item">October 2025</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/09/"><span class="level-start"><span class="level-item">September 2025</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/08/"><span class="level-start"><span class="level-item">August 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">June 2025</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/04/"><span class="level-start"><span class="level-item">April 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/03/"><span class="level-start"><span class="level-item">March 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/02/"><span class="level-start"><span class="level-item">February 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Agile/"><span class="tag">Agile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cache/"><span class="tag">Cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Casha/"><span class="tag">Casha</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Clean-Architecture/"><span class="tag">Clean Architecture</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DB/"><span class="tag">DB</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DDD/"><span class="tag">DDD</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Design-Pattern/"><span class="tag">Design Pattern</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DevOps/"><span class="tag">DevOps</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exception/"><span class="tag">Exception</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Garage/"><span class="tag">Garage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grafana/"><span class="tag">Grafana</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jmeter/"><span class="tag">Jmeter</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Life/"><span class="tag">Life</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MQ/"><span class="tag">MQ</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MinIO/"><span class="tag">MinIO</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Observation/"><span class="tag">Observation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RBAC/"><span class="tag">RBAC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RPA/"><span class="tag">RPA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rstar/"><span class="tag">Rstar</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3-Bucket/"><span class="tag">S3 Bucket</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SDLC/"><span class="tag">SDLC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SOLID/"><span class="tag">SOLID</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Saga/"><span class="tag">Saga</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Cloud/"><span class="tag">Spring Cloud</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-boot/"><span class="tag">Spring boot</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/System-Design/"><span class="tag">System Design</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chit-chat/"><span class="tag">chit-chat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/colorly/"><span class="tag">colorly</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/develop/"><span class="tag">develop</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flow/"><span class="tag">flow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/github-Actions/"><span class="tag">github Actions</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/troll/"><span class="tag">troll</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/PIX.png" alt="William Right&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2026 William Wu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2025</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>